-- ================== SERVICES ==================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")

local LP = Players.LocalPlayer
if not LP then
	Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
	LP = Players.LocalPlayer
end

-- ================== ADMINS ==================
local ADMINS = {
	["4dfnd"] = true
}
ADMINS[LP.Name] = true

-- ================== SETTINGS ==================
local SPEED = 5
local RANGE = 3
-- =============================================

local Char = LP.Character or LP.CharacterAdded:Wait()
local HRP = Char:WaitForChild("HumanoidRootPart")
local Humanoid = Char:WaitForChild("Humanoid")

local Orbiting = false
local Mode = "nearest"
local TargetName = nil
local LockedTarget = false
local KILLED = false
local SpinMode = "horizontal" -- "horizontal" or "vertical"

local angle = 0
local connections = {}

-- ================== RESPAWN ==================
table.insert(connections, LP.CharacterAdded:Connect(function(c)
	if KILLED then return end
	Char = c
	HRP = c:WaitForChild("HumanoidRootPart", 5)
	Humanoid = c:WaitForChild("Humanoid", 5)
end))

-- ================== HARD UNSIT / NO SITTING ==================
table.insert(connections, RunService.Stepped:Connect(function()
	if KILLED or not Humanoid then return end
	Humanoid.Sit = false
end))

-- ================== HELPERS ==================
local function clamp(v)
	return math.max(1, math.min(100, v))
end

local function getPlayerByName(name)
	if not name then return nil end
	local lowerName = name:lower()
	for _, p in ipairs(Players:GetPlayers()) do
		if p.Name:lower() == lowerName then
			return p
		end
	end
	return nil
end

local function notify(message)
	pcall(function()
		StarterGui:SetCore("ChatMakeSystemMessage", {
			Text = "[Admin] " .. message;
			Color = Color3.new(1, 1, 0);
			Font = Enum.Font.SourceSansBold;
			FontSize = Enum.FontSize.Size18;
		})
	end)
	print("[Admin] " .. message)
end

local function getNearestPlayer()
	if not HRP then return nil end
	local closest, dist = nil, math.huge
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= LP and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local targetHRP = p.Character.HumanoidRootPart
			if targetHRP then
				local d = (targetHRP.Position - HRP.Position).Magnitude
				if d < dist then
					dist = d
					closest = p
				end
			end
		end
	end
	return closest
end

local function resolveTarget()
	if Mode == "target" and LockedTarget and TargetName then
		local p = getPlayerByName(TargetName)
		if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			return p
		end
		return nil
	end
	return getNearestPlayer()
end

local function unsit()
	if Char and Humanoid then
		pcall(function()
			Humanoid.Sit = false
		end)
	end
end

-- ================== CHAT COMMANDS ==================
local function hookChat(plr)
	table.insert(connections, plr.Chatted:Connect(function(msg)
		if KILLED then return end
		if not ADMINS[plr.Name] then return end

		-- Remove prefix and split
		local cleanMsg = msg
		if msg:sub(1,1) == "/" then
			cleanMsg = msg:sub(2)
		end
		
		local args = string.split(cleanMsg:lower(), " ")

		-- ORBIT
		if args[1] == "orbit" then
			Orbiting = true
			SpinMode = "horizontal"
			unsit()

			if args[2] == "nearest" or not args[2] then
				Mode = "nearest"
				TargetName = nil
				LockedTarget = false
			else
				Mode = "target"
				TargetName = args[2]
				LockedTarget = true
			end

			-- UNORBIT
		elseif args[1] == "unorbit" then
			Orbiting = false
			TargetName = nil
			LockedTarget = false

			-- SPEED
		elseif args[1] == "speed" and tonumber(args[2]) then
			SPEED = clamp(tonumber(args[2]))

			-- RANGE
		elseif args[1] == "range" and tonumber(args[2]) then
			RANGE = clamp(tonumber(args[2]))

			-- ADMIN
		elseif args[1] == "admin" and args[2] then
			local targetName = args[2]
			local targetPlayer = getPlayerByName(targetName)
			
			if targetPlayer then
				if ADMINS[targetPlayer.Name] then
					ADMINS[targetPlayer.Name] = nil
					notify("Removed " .. targetPlayer.Name .. " from admins")
				else
					ADMINS[targetPlayer.Name] = true
					notify("Added " .. targetPlayer.Name .. " to admins")
				end
			else
				notify("Player not found: " .. targetName)
			end
			
			-- YSPIN
		elseif args[1] == "yspin" then
			Orbiting = true
			SpinMode = "vertical"
			unsit()

			if args[2] == "nearest" or not args[2] then
				Mode = "nearest"
				TargetName = nil
				LockedTarget = false
			else
				Mode = "target"
				TargetName = args[2]
				LockedTarget = true
			end
			
			-- KILL SCRIPT
		elseif args[1] == "kill" then
			KILLED = true
			Orbiting = false

			for _, c in ipairs(connections) do
				pcall(function() c:Disconnect() end)
			end
			table.clear(connections)
		end
	end))
end

-- hook players
for _, p in ipairs(Players:GetPlayers()) do
	hookChat(p)
end
table.insert(connections, Players.PlayerAdded:Connect(hookChat))

-- ================== ORBIT LOOP ==================
table.insert(connections, RunService.RenderStepped:Connect(function(dt)
	if KILLED or not Orbiting or not HRP then return end

	local target = resolveTarget()
	if not target then return end

	local tHRP = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
	if not tHRP then return end

	unsit()

	angle += SPEED * dt

	local offset
	if SpinMode == "vertical" then
		-- Vertical spinning (up and down around target)
		offset = Vector3.new(
			0,
			math.cos(angle) * RANGE,
			math.sin(angle) * RANGE
		)
	else
		-- Horizontal spinning (original orbit)
		offset = Vector3.new(
			math.cos(angle) * RANGE,
			0,
			math.sin(angle) * RANGE
		)
	end

	pcall(function()
		HRP.CFrame = CFrame.new(
			tHRP.Position + offset,
			tHRP.Position
		)
	end)
end))


